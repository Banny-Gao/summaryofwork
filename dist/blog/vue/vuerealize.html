<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue2.xåŸç†æµ…æ | Summary Of work</title>
    <meta name="description" content="The description of the site.">
    <link rel="icon" href="/SummaryOfwork/logo.png">
    
    <link rel="preload" href="/SummaryOfwork/assets/css/0.styles.eaca21c9.css" as="style"><link rel="preload" href="/SummaryOfwork/assets/js/app.775f6a5d.js" as="script"><link rel="preload" href="/SummaryOfwork/assets/js/33.be1909ae.js" as="script"><link rel="prefetch" href="/SummaryOfwork/assets/js/1.8b9d42cd.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/10.a3646196.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/11.87fe5399.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/12.7dfac753.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/13.f2906969.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/14.a1d35ce0.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/15.117e619d.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/16.f333c039.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/17.f6282cc8.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/18.186208f4.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/19.3404f2bf.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/2.30bb0b92.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/20.a04fb7c5.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/21.aef6b58c.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/22.5c0585dd.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/23.8eabeaf5.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/24.5e9ef0ae.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/25.c40b2c56.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/26.fa1f3999.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/27.cbaf4b3d.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/28.15360d45.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/29.16606e06.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/3.7848cd7c.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/30.53c3393f.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/31.73560268.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/32.668e2fe2.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/34.6bc81de6.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/35.a9e71e4d.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/36.2c10ffb1.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/37.2ef07c9b.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/38.656420be.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/39.389dedf0.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/40.c5ee331c.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/41.c34d62d2.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/42.b551027f.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/5.e1a5363a.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/6.ac7f6d94.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/7.c3a0b0bc.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/8.02b276ff.js"><link rel="prefetch" href="/SummaryOfwork/assets/js/9.c94d1b44.js">
    <link rel="stylesheet" href="/SummaryOfwork/assets/css/0.styles.eaca21c9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/SummaryOfwork/" class="home-link router-link-active"><!----> <span class="site-name">Summary Of work</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/SummaryOfwork/" class="nav-link">ğŸ </a></div><div class="nav-item"><a href="/SummaryOfwork/nav/" class="nav-link">ğŸ•œ</a></div><div class="nav-item"><a href="/SummaryOfwork/blog/" class="nav-link router-link-active">æ±‚çŸ¥</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">å¥½å­¦</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/SummaryOfwork/bookReading/" class="nav-link">ğŸ“šè¯»ä¹¦</a></li><li class="dropdown-item"><!----> <a href="/SummaryOfwork/resource/" class="nav-link">ğŸ“‚èµ„æº</a></li><li class="dropdown-item"><!----> <a href="/SummaryOfwork/article/" class="nav-link">ğŸ“ƒæ–‡ç« </a></li></ul></div></div><div class="nav-item"><a href="/SummaryOfwork/algorithm/" class="nav-link">Algorithm</a></div><div class="nav-item"><a href="https://github.com/xinandiyishuai/SummaryOfWork" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gayhub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/SummaryOfwork/" class="nav-link">ğŸ </a></div><div class="nav-item"><a href="/SummaryOfwork/nav/" class="nav-link">ğŸ•œ</a></div><div class="nav-item"><a href="/SummaryOfwork/blog/" class="nav-link router-link-active">æ±‚çŸ¥</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">å¥½å­¦</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/SummaryOfwork/bookReading/" class="nav-link">ğŸ“šè¯»ä¹¦</a></li><li class="dropdown-item"><!----> <a href="/SummaryOfwork/resource/" class="nav-link">ğŸ“‚èµ„æº</a></li><li class="dropdown-item"><!----> <a href="/SummaryOfwork/article/" class="nav-link">ğŸ“ƒæ–‡ç« </a></li></ul></div></div><div class="nav-item"><a href="/SummaryOfwork/algorithm/" class="nav-link">Algorithm</a></div><div class="nav-item"><a href="https://github.com/xinandiyishuai/SummaryOfWork" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gayhub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span></span> <!----></p> <ul class="sidebar-group-items"><li><a href="/SummaryOfwork/blog/" class="sidebar-link">é¢è¯•æ—¥å¸¸</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>vue</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/SummaryOfwork/blog/vue/vuerealize.html" class="active sidebar-link">Vue2.xåŸç†æµ…æ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/SummaryOfwork/blog/vue/vuerealize.html#object-defineproperty" class="sidebar-link">Object.defineProperty</a></li><li class="sidebar-sub-header"><a href="/SummaryOfwork/blog/vue/vuerealize.html#vueä¸­è§‚å¯Ÿè€…" class="sidebar-link">vueä¸­è§‚å¯Ÿè€…</a></li><li class="sidebar-sub-header"><a href="/SummaryOfwork/blog/vue/vuerealize.html#class-dep" class="sidebar-link">Class Dep</a></li><li class="sidebar-sub-header"><a href="/SummaryOfwork/blog/vue/vuerealize.html#class-watcher" class="sidebar-link">Class Watcher</a></li><li class="sidebar-sub-header"><a href="/SummaryOfwork/blog/vue/vuerealize.html#class-observer" class="sidebar-link">Class Observer</a></li><li class="sidebar-sub-header"><a href="/SummaryOfwork/blog/vue/vuerealize.html#example" class="sidebar-link">Example</a></li><li class="sidebar-sub-header"><a href="/SummaryOfwork/blog/vue/vuerealize.html#class-vue" class="sidebar-link">Class Vue</a></li><li class="sidebar-sub-header"><a href="/SummaryOfwork/blog/vue/vuerealize.html#class-compiler" class="sidebar-link">Class Compiler</a></li></ul></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>js</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/SummaryOfwork/blog/js/reduce.html" class="sidebar-link">reduceå®ç°</a></li><li><a href="/SummaryOfwork/blog/js/åŸºç¡€å¿…å¤‡ä¹‹åå¤§ç»å…¸æ’åº.html" class="sidebar-link">åŸºç¡€å¿…å¤‡ä¹‹åå¤§ç»å…¸æ’åº</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="vue2-xåŸç†æµ…æ">Vue2.xåŸç†æµ…æ</h1> <p>ä¸€è¯´åˆ°vueçš„å®ç°åŸç†ï¼Œæˆ‘ä»¬é¦–å…ˆæƒ³åˆ°æ˜¯çš„è§‚å¯Ÿè€…æ¨¡å¼åœ¨æ•°æ®åŠ«æŒ(<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty" target="_blank" rel="noopener noreferrer">Object.defineProperty<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)ä¸­çš„ä½¿ç”¨ã€‚é‚£ä¹ˆï¼Œä»€ä¹ˆæ•°æ®åŠ«æŒï¼Ÿä½•è°“è§‚å¯Ÿè€…æ¨¡å¼ï¼Ÿ</p> <h2 id="object-defineproperty">Object.defineProperty</h2> <p>ç®€å•æ¥è¯´ï¼Œæ•°æ®åŠ«æŒâ†“</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  a<span class="token punctuation">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// value : 37,   // å€¼ï¼Œä¸getã€setæ–¹æ³•ä¸èƒ½åŒæ—¶å­˜åœ¨</span>
  writable <span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token comment">// å¯å¦è¢«ä¿®æ”¹</span>
  enumerable <span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>   <span class="token comment">// å¯å¦è¢«æšä¸¾  for in</span>
  configurable <span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">// å¯å¦è¢«åˆ é™¤ delete</span>
  <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">3</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">set</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>é€šè¿‡è¿™ä¸ªapiï¼Œæˆ‘ä»¬å¯ä»¥æ•æ‰åˆ°åŠ«æŒå¯¹è±¡é”®å€¼çš„è·å–å’Œæ”¹å˜ã€‚å¹¶å¯ä»¥åœ¨å…¶ä¸­Do what we want do.</p> <p>ä½†æ˜¯ğŸ˜°æœ‰ä¸ªå¼Šç«¯ =&gt; æ•°æ®ä¸‹æ ‡ä¹Ÿæ˜¯æ•°ç»„çš„é”®ï¼Œå¯¹äºæ•°ç»„å¯¹è±¡ä¸‹æ ‡èµ‹å€¼ä¸ä¼šç”Ÿæ•ˆ</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">3</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">set</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>é‚£ä¹ˆï¼Œè‡ªå®šä¹‰ä¸€ä¸ªæ•°ç»„è‡ªèº«å˜åŒ–çš„æ˜¯è¦æ€ä¹ˆå»ç›‘å¬å‘¢ï¼Œè¯´å¥½çš„ç”¨<strong>Object.defineProperty</strong>æ”¹å˜ä¸–ç•Œå‘¢ï¼Ÿ<br>
ç»†æƒ³ä¸€ä¸‹ï¼Œ<strong>æ•°ç»„åŸå‹</strong>ä¸Šæœ‰è‡ªå·±æœ‰ä»¥ä¸‹æ–¹æ³•å¯ä»¥æ”¹å˜è‡ªå·±ï¼Œèƒ½æƒ³åˆ°çš„éƒ½åœ¨ä¸‹é¢äº†</p> <blockquote><p>[ 'push','pop','shift','unshift','splice','sort','reverse' ]</p></blockquote> <p>æˆ‘ä»¬å¯ä»¥åŠ«æŒè¿™äº›keyï¼Œå½“getè®¿é—®æ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬å°±èƒ½æ•è·åˆ°æ•°ç»„æ”¹å˜çš„åŠ¨ä½œäº†ã€‚å…‰è¯´ä¸ç»ƒå‡æŠŠå¼â†“</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> arrayProto <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype   <span class="token comment">// æ‹·è´åŸå‹é˜²æ­¢æ±¡æŸ“Array</span>
<span class="token keyword">const</span> arrayMethods <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>arrayProto<span class="token punctuation">)</span>
<span class="token keyword">const</span> methodsToPatch <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'push'</span><span class="token punctuation">,</span>
  <span class="token string">'pop'</span><span class="token punctuation">,</span>
  <span class="token string">'shift'</span><span class="token punctuation">,</span>
  <span class="token string">'unshift'</span><span class="token punctuation">,</span>
  <span class="token string">'splice'</span><span class="token punctuation">,</span>
  <span class="token string">'sort'</span><span class="token punctuation">,</span>
  <span class="token string">'reverse'</span>
<span class="token punctuation">]</span>
methodsToPatch<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">//å¯¹æ•°ç»„ä¸­æ”¹å˜è‡ªèº«çš„æ–¹æ³•åŠ«æŒ</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>arrayMethods<span class="token punctuation">,</span> item<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">value</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      arrayProto<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">...</span>arguments<span class="token punctuation">)</span> <span class="token comment">//æ‰§è¡Œæ–¹æ³•</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
arr<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> arrayMethods
arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>  
</code></pre></div><p>ç„¶åï¼Œæˆ‘ä»¬å†æ¥ç®€å•åœ°çœ‹çœ‹æ‰€è°“è§‚å¯Ÿè€…æ¨¡å¼â†“</p> <ul><li><strong><a href="/SummaryOfwork/bookReading/Javascriptè®¾è®¡æ¨¡å¼/9.html">è§‚å¯Ÿè€…æ¨¡å¼</a></strong></li></ul> <h2 id="vueä¸­è§‚å¯Ÿè€…">vueä¸­è§‚å¯Ÿè€…</h2> <p>Subjectæ˜¯è¦å¹²å˜›ï¼ŸSubjectå³æ˜¯è¦æ·»åŠ åˆ é™¤é€šçŸ¥Observeræ›´æ–°ã€‚æ‰€ä»¥vueä¸­çš„depæˆ‘ä»¬å¯ä»¥ç®€å•çš„è¿™æ ·æ¥å†™â†“<br> <strong>dep.js</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> 
  <span class="token punctuation">}</span>
  <span class="token function">addSub</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//é€šçŸ¥è®¢é˜…è€…æ›´æ–°</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'dep notify'</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      sub<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æœ‰äº†Subjectï¼Œæˆ‘ä»¬è¿˜å·®Observerå’ŒConcreteSubjectï¼ŒObserverå³æ˜¯æä¾›ä¸€ä¸ªæ¥å£åœ¨Subjectæ´¾å‘notifyçš„æ—¶å€™é€šçŸ¥ConcreteSubjectæ›´æ–°ã€‚é‚£ä¹ˆï¼Œæ—¢ç„¶è¦ç”¨Object.definePropertyï¼Œè¯¥æ€æ ·è®¾è®¡æ‰èƒ½è®©ä»–ä»¬ç»“åˆèµ·æ¥å‘¢ï¼Ÿå…ˆä¸è€ƒè™‘ConcreteSubjectï¼ŒObserverä¸€ä¸ªå¯¹è±¡obj = {a: 1}ï¼Œè¦ä¸definePropertyç»“åˆèµ·æ¥ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨objé”®å€¼æ”¹å˜æ‰§è¡Œsetçš„æ—¶å€™è®©Subjecté€šçŸ¥æ›´æ–° â†“<br> <strong>observer.js</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> Dep <span class="token keyword">from</span> <span class="token string">'./dep'</span>
<span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">walk</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">defineReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">// é‡æ–°åŒ…è£…</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> val <span class="token operator">=</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      enumerabel<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> 
      configurabel<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> val
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">set</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">===</span> val<span class="token punctuation">)</span> <span class="token keyword">return</span>
        val <span class="token operator">=</span> newVal
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in set key =&gt;'</span> <span class="token operator">+</span> key<span class="token punctuation">)</span>
        dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//é€šçŸ¥æ›´æ–°</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
obj<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">2</span>
</code></pre></div><p>è‡³æ­¤ï¼Œï¼Œç»“åˆäº†çš„Object.definePropertyï¼Œobjæ”¹å˜é€šçŸ¥Subjectæ‰§è¡Œnotifyå·²æ˜¯å¯è¡Œã€‚ä½†æ˜¯depçš„subsè¿˜æ˜¯ç©ºçš„ï¼Œåº”è¯¥ä»€ä¹ˆæ—¶å€™è®©Subjectæ·»åŠ Observerå‘¢ï¼Ÿä¸”notifyé‡Œsubçš„updateæ¥å£ä¹Ÿè¿˜æœªå®ç°ã€‚æˆ‘ä»¬æ˜¯å¦åº”è¯¥ç»™Observerä¸€ä¸ªupdateæ¥å£ï¼Ÿä¸äº†ï¼Œè¿™ä¸ªæ—¶å€™æœ‰ä¸ªWatcherè¯¥ç™»åœºäº†ï¼Œè®©Watcherå»ä»£æ›¿Observeræä¾›ä¸€ä¸ªupdateçš„æ¥å£ï¼Œæˆ–è€…è¯´Watcherä¾¿æ˜¯ConcreteSubjectï¼Œçœå»äº†observerè€Œç›´æ¥updateäº†ï¼Œè¿™æ˜¯vueä¸­çš„å®ç°æ–¹æ¡ˆã€‚<br>
é¦–å…ˆï¼Œå®Œå–„Subject â†“</p> <h2 id="class-dep">Class Dep</h2> <p><strong>dep.js</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
  <span class="token comment">//è®¢é˜…å™¨  ==&gt;  æ”¶é›†è®¢é˜…è€…</span>
  <span class="token keyword">static</span> target <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">//æ”¶é›†watcheræ•°ç»„</span>
  <span class="token punctuation">}</span>
  <span class="token function">addSub</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//æ·»åŠ watcherçš„æ–¹æ³•</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">removeSub</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// ç§»é™¤watcher</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//ä¼ å…¥è®¢é˜…å™¨ï¼Œç„¶åæ·»åŠ è®¢é˜…è€…</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> Dep<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">addDep</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log('notify', this.subs)</span>
    <span class="token comment">//é€šçŸ¥è®¢é˜…è€…æ›´æ–°</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      sub<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> targetStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// å­˜æ”¾targetçš„æ•°ç»„</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">pushTarget</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  targetStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> target
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">popTarget</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  targetStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> targetStack<span class="token punctuation">[</span>targetStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åˆåˆ°äº†æ€è€ƒçš„æ—¶å€™ï¼Œæ€æ ·è®©Watcherä½œä¸ºConcreteSubjectå´åˆå’ŒObserverå…³è”èµ·æ¥å‘¢ï¼Ÿä¹Ÿè®¸æ˜¯é‚£è¢«Observeräº†çš„é‚£ä¸ªobjï¼Ÿä»€ä¹ˆæ—¶å€™è¯¥è®©depæ·»åŠ watcherå‘¢ï¼Ÿä»€ä¹ˆæ—¶å€™watcheråˆåº”è¯¥å»æ‰§è¡Œdepçš„notifyå‘¢ï¼Ÿå¸¦ç€ç–‘æƒ‘ï¼Œæˆ‘ä»¬èµ°è¿›æºç ã€‚</p> <ul><li><strong>Objectçš„æœ‰ç”¨å´ä¸å¸¸ç”¨çš„å‡ ä¸ªæ–¹æ³•</strong>: <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/create" target="_blank" rel="noopener noreferrer">create<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ã€<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/freeze" target="_blank" rel="noopener noreferrer">freeze<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ã€<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/hasOwnProperty" target="_blank" rel="noopener noreferrer">hasOwnProperty<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ã€<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyNames" target="_blank" rel="noopener noreferrer">getOwnPropertyNames<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ã€<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyDescriptor" target="_blank" rel="noopener noreferrer">getOwnPropertyDescriptor<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ã€<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/GetPrototypeOf" target="_blank" rel="noopener noreferrer">getPrototypeOf<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>æWatcherä¹‹å‰ï¼Œå…ˆæŠŠObserverç¨å¾®å®Œå–„ä¸€ä¸‹å§ â†“<br> <strong>observer.js</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data
    <span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// ä»¥å¤‡ä¸æ—¶ä¹‹éœ€</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">walk</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">defineReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
   <span class="token comment">// æ•°æ®åŠ«æŒ/åŒ…è£…</span>
  <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> _this <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> property <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token comment">//ä¸åŒ…æ‹¬Symbolå€¼çš„æ‰€æœ‰å±æ€§çš„æè¿°,å³enumerabelã€configurabelç­‰</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>property<span class="token operator">?</span><span class="token punctuation">.</span>configurable <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment">// å¤„ç†ä¸å¯ä¿®æ”¹å±æ€§</span>
    <span class="token keyword">const</span> getter <span class="token operator">=</span> property<span class="token operator">?</span><span class="token punctuation">.</span>get <span class="token comment">// getæ–¹æ³•æ˜¯å¦è¢«ä¿®æ”¹</span>
    <span class="token keyword">const</span> setter <span class="token operator">=</span> property<span class="token operator">?</span><span class="token punctuation">.</span>set <span class="token comment">// setæ–¹æ³•æ˜¯å¦è¢«ä¿®æ”¹</span>
    <span class="token keyword">let</span> val <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">let</span> childObj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token comment">// å¤„ç†å€¼æ˜¯å¯¹è±¡çš„æƒ…å†µ</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      enumerabel<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      configurabel<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> value <span class="token operator">=</span> getter<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">?</span><span class="token operator">?</span> val
        dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>childObj<span class="token punctuation">)</span> childObj<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// è¿™é‡Œçš„depå°±æ˜¯ä»ã€ä»¥å¤‡ä¸æ—¶ä¹‹éœ€ã€‘æ¥çš„</span>
        <span class="token keyword">return</span> value
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">set</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> value <span class="token operator">=</span> getter<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">?</span><span class="token operator">?</span> val
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">===</span> value<span class="token punctuation">)</span> <span class="token keyword">return</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>setter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">setter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          val <span class="token operator">=</span> newVal
        <span class="token punctuation">}</span>
        childObj <span class="token operator">=</span> _this<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token comment">// å¤„ç†æ–°å€¼æ˜¯å¯¹è±¡çš„æƒ…å†µ</span>
        dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>value <span class="token operator">||</span> <span class="token keyword">typeof</span> value <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token comment">//åªå¯¹objectè¿›è¡ŒåŠ«æŒ</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä»åŠæˆå“çš„Observerï¼Œæˆ‘ä»¬èƒ½çœ‹åˆ°åœ¨getçš„æ—¶å€™èµ°äº†dep.dependï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨è¿™ä¸ªæ˜¯Subjectæ‰èƒ½å»æ·»åŠ watcherï¼Œä»Depçš„æ–¹æ³•å¯ä»¥çœ‹å‡ºï¼Œå½“å‰Depçš„targetå­˜åœ¨ä¸”æ˜¯watcherï¼Œç”±watcherè°ƒç”¨Depçš„æ–¹æ³•æ·»åŠ è‡ªèº«ï¼Œè€Œä¸”æ·»åŠ è¿‡åå¾—æ¸…é™¤Depçš„targetï¼Œä¸ç„¶æ¯æ¬¡objå–å€¼çš„æ—¶å€™éƒ½ä¼šæ·»åŠ ä¸€æ¬¡watcherã€‚
ä½œä¸ºConcreteSubjectçš„watcherè¦åœ¨notifyçš„æ—¶å€™å¹²å˜›å‘¢ï¼Ÿç®€å•ç‚¹ï¼Œå¦‚æœæˆ‘ä»¬åªæƒ³çŸ¥é“æ–°æ—§å€¼å‘¢ï¼Ÿ</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> Observer <span class="token keyword">from</span> <span class="token string">'../../util/vue/observer'</span>
<span class="token keyword">import</span> Watcher <span class="token keyword">from</span> <span class="token string">'../../util/vue/watcher'</span>

<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  a<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  b<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  d<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token keyword">const</span> watcher1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span> oldVal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> watcher2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'b.c'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span> oldVal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> watcher3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span> oldVal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
data<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">2</span>
data<span class="token punctuation">.</span>b<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token number">1</span>
data<span class="token punctuation">.</span>d<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre></div><p>è¯¥æ€æ ·å»å®ç°è¿™ä¸ªWatcherå‘¢ï¼Ÿ</p> <ul><li>å…ˆæœ‰Observeråæœ‰Watcherï¼Œè¿™æ ·æ‰èƒ½dependå˜›</li> <li>Watcheråˆå§‹åŒ–çš„æ—¶å€™å¾—è¿‡ä¸€édepend</li> <li>Watcheræœ‰ä¸ªupdate</li></ul> <h2 id="class-watcher">Class Watcher</h2> <p><strong>vue/watcher.js</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> _ <span class="token keyword">from</span> <span class="token string">'lodash'</span>
<span class="token keyword">import</span> Dep<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  pushTarget<span class="token punctuation">,</span>
  popTarget
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./dep'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm
    <span class="token keyword">this</span><span class="token punctuation">.</span>exp <span class="token operator">=</span> expOrFn  
    <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initGetter</span><span class="token punctuation">(</span>expOrFn<span class="token punctuation">)</span>  
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">initGetter</span><span class="token punctuation">(</span><span class="token parameter">expOrFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>expOrFn<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'[object Function]'</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> expOrFn<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> expOrFn <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parsePath</span><span class="token punctuation">(</span>expOrFn<span class="token punctuation">)</span>  <span class="token comment">// å¤„ç†a.bç­‰æƒ…å†µ</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">pushTarget</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm
    <span class="token keyword">let</span> value
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> vm<span class="token punctuation">)</span> <span class="token comment">// callï¼Œapplyï¼Œbindèƒ½æ”¹å˜ç®­å¤´å‡½æ•°thisæŒ‡å‘å—ï¼Ÿ</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        value <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">cloneDeep</span><span class="token punctuation">(</span> value <span class="token punctuation">)</span> <span class="token comment">// ç®€å•æ›¿ä»£æºç ä¸­çš„traverseè§£å†³å¼•ç”¨ç±»å‹é—®é¢˜</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">popTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> value
  <span class="token punctuation">}</span>
  <span class="token function">addDep</span><span class="token punctuation">(</span><span class="token parameter">dep</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>  <span class="token comment">// æ·»åŠ åˆ°dep</span>
  <span class="token punctuation">}</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// depçš„update</span>
    <span class="token comment">// ä»€ä¹ˆ</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">parsePath</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> segments <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> segments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">)</span> <span class="token keyword">return</span>
        obj <span class="token operator">=</span> obj<span class="token punctuation">[</span>segments<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> obj
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm
    <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
    <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>value <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">cloneDeep</span><span class="token punctuation">(</span> value <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> oldValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value
      <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span> value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span>  <span class="token comment">// å›è°ƒ</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token operator">?</span><span class="token punctuation">.</span>updated<span class="token operator">?</span><span class="token operator">?</span> <span class="token keyword">null</span>  
    <span class="token comment">// console.log(this.vm)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// vueçš„updatedç”Ÿå‘½å‘¨æœŸé’©å­</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Wathceræœ‰äº†ï¼ŒVueçš„å®ç°æœ‰äº†ä¸€ç‚¹ç‚¹çœ‰ç›®äº†ã€‚æˆ‘ä»¬å¤§æ¦‚å¯ä»¥çŒœåˆ°Vueä¸­çš„MVVMå¤§æ¦‚å°±æ˜¯Vueæ‰€ç®¡ç†çš„dataè¢«Observeräº†ï¼Œviewå’Œdataä¹‹é—´åˆå»ºç«‹çš„å¾ˆå¤šä¸ªWatcherï¼Œviewçš„æ›´æ–°ä¹Ÿå°±æ˜¯æ‰§è¡Œäº†Watcherçš„å›è°ƒå‡½æ•°ã€‚<br>
é‚£ä¹ˆï¼Œæˆ‘ä»¬å…ˆå®Œå–„ä¸€ä¸‹Observerï¼Œæäº†å¯¹è±¡ï¼Œè¿˜æœ‰æ•°ç»„çš„æƒ…å†µæ²¡å¤„ç†å‘¢</p> <ul><li>æ•°ç»„ä¹Ÿè¯¥depend</li> <li>æ•°ç»„ä¹Ÿè¯¥notify</li> <li>ä¸èƒ½å«Œå¼ƒæ•°ç»„ä¸‹æ ‡ä¸èƒ½Object.defineProperty</li></ul> <h2 id="class-observer">Class Observer</h2> <p><strong>vue/observer.js</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// @ts-nocheck</span>
<span class="token keyword">import</span> Dep <span class="token keyword">from</span> <span class="token string">'./dep'</span>
<span class="token keyword">const</span> <span class="token function-variable function">def</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> enumerable <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> val<span class="token punctuation">,</span>
    enumerable<span class="token punctuation">:</span> <span class="token operator">!</span><span class="token operator">!</span>enumerable<span class="token punctuation">,</span>
    writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    configurable<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> arrayProto <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype  <span class="token comment">// æ‹·è´åŸå‹é˜²æ­¢æ±¡æŸ“Array</span>
<span class="token keyword">const</span> arrayMethods <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>arrayProto<span class="token punctuation">)</span>
<span class="token keyword">const</span> methodsToPatch <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'push'</span><span class="token punctuation">,</span>
  <span class="token string">'pop'</span><span class="token punctuation">,</span>
  <span class="token string">'shift'</span><span class="token punctuation">,</span>
  <span class="token string">'unshift'</span><span class="token punctuation">,</span>
  <span class="token string">'splice'</span><span class="token punctuation">,</span>
  <span class="token string">'sort'</span><span class="token punctuation">,</span>
  <span class="token string">'reverse'</span>
<span class="token punctuation">]</span>
methodsToPatch<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">def</span><span class="token punctuation">(</span>arrayMethods<span class="token punctuation">,</span> method<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log(this)   </span>
    <span class="token keyword">const</span> ob <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>__ob__
    <span class="token keyword">let</span> inserted
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>
      method <span class="token comment">// ä¹Ÿè®¸æ·»åŠ äº†æ•°ç»„æˆ–è€…å¯¹è±¡ï¼Œéœ€è¦é‡æ–°Observer</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">'push'</span><span class="token punctuation">:</span>
      <span class="token keyword">case</span> <span class="token string">'unshift'</span><span class="token punctuation">:</span>
        inserted <span class="token operator">=</span> args
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'splice'</span><span class="token punctuation">:</span>
        inserted <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> 
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inserted<span class="token punctuation">)</span> ob<span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>inserted<span class="token punctuation">)</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> arrayProto<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token comment">// notify change</span>
    ob<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">// æ•°ç»„å˜åŒ–é€šçŸ¥æ›´æ–°</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//  æ•°ç»„ä¿®å¤</span>
<span class="token keyword">const</span> arrayKeys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>arrayMethods<span class="token punctuation">)</span> <span class="token comment">//è·å–æ•°ç»„åŠ«æŒçš„æ–¹æ³•</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data
    <span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// ä»¥å¤‡ä¸æ—¶ä¹‹éœ€</span>
    <span class="token function">def</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'__ob__'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>   <span class="token comment">// ä¸Šé¢æ•°ç»„è¦ç”¨</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> augment <span class="token operator">=</span> data<span class="token punctuation">.</span>__proto__ <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>protoAugment <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>copyAugment
      <span class="token comment">// è·å–æ›¿æ¢åŸå‹çš„æ–¹æ³•</span>
      <span class="token comment">//æ­¤å¤„çš„ arrayMethods å°±æ˜¯ä¸Šé¢ä½¿ç”¨Object.definePropertyå¤„ç†è¿‡</span>
      <span class="token function">augment</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> arrayMethods<span class="token punctuation">,</span> arrayKeys<span class="token punctuation">)</span> <span class="token comment">//å°†ä¼ è¿›æ¥çš„æ•°ç»„æ›¿æ¢åŸå‹ï¼Œä»¥åå½“å‰dataä½¿ç”¨pushä»€ä¹ˆçš„ï¼Œå°±æ˜¯arrayMethodsçš„åŠ«æŒäº†</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">//æ•°ç»„çš„è®¢é˜…å™¨æ·»åŠ </span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">walk</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// ä¸ºæ‰€æœ‰å¯æšä¸¾çš„keyèµ°åŒ…è£…</span>
    <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">defineReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">observeArray</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// æ•°ç»„çš„åŒ…è£…</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// æ•°æ®åŠ«æŒ/åŒ…è£…</span>
  <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> shallow <span class="token operator">=</span> <span class="token boolean">true</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// é»˜è®¤æµ…åŒ…è£…</span>
    <span class="token keyword">const</span> _this <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> property <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token comment">//ä¸åŒ…æ‹¬Symbolå€¼çš„æ‰€æœ‰å±æ€§çš„æè¿°,å³enumerabelã€configurabelç­‰</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>property <span class="token operator">?</span><span class="token punctuation">.</span>configurable <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment">// å¤„ç†ä¸å¯ä¿®æ”¹å±æ€§</span>
    <span class="token keyword">const</span> getter <span class="token operator">=</span> property <span class="token operator">?</span><span class="token punctuation">.</span>get <span class="token comment">// getæ–¹æ³•æ˜¯å¦è¢«ä¿®æ”¹</span>
    <span class="token keyword">const</span> setter <span class="token operator">=</span> property <span class="token operator">?</span><span class="token punctuation">.</span>set <span class="token comment">// setæ–¹æ³•æ˜¯å¦è¢«ä¿®æ”¹</span>
    <span class="token keyword">let</span> val <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">let</span> childObj <span class="token operator">=</span> <span class="token operator">!</span>shallow <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token comment">// å¤„ç†å€¼æ˜¯å¯¹è±¡çš„æƒ…å†µ</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      enumerabel<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      configurabel<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> value <span class="token operator">=</span> getter <span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">?</span><span class="token operator">?</span> val
        dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>childObj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          childObj<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// è¿™é‡Œçš„depå°±æ˜¯ä»ã€ä»¥ä¸ºä¸æ—¶ä¹‹éœ€ã€‘æ¥çš„</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              _this<span class="token punctuation">.</span><span class="token function">dependArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>   <span class="token comment">// æ–°è®¾ç½®çš„æ˜¯æ•°æ®ï¼Œèµ°æ•°ç»„åŒ…è£…</span>
          <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> value
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">set</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> value <span class="token operator">=</span> getter <span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">?</span><span class="token operator">?</span> val  <span class="token comment">// ä»è¢«ä¿®æ”¹çš„getæ‹¿å€¼ï¼Œ computedä¸­çš„getï¼Ÿ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">===</span> value<span class="token punctuation">)</span> <span class="token keyword">return</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>setter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">setter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          val <span class="token operator">=</span> newVal
        <span class="token punctuation">}</span>
        childObj <span class="token operator">=</span> <span class="token operator">!</span>shallow <span class="token operator">&amp;&amp;</span> _this<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token comment">// å¤„ç†æ–°å€¼æ˜¯å¯¹è±¡çš„æƒ…å†µ</span>
        dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">// æ•°æ®å˜åŒ–é€šçŸ¥æ›´æ–°</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>value <span class="token operator">||</span> <span class="token keyword">typeof</span> value <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">let</span> ob
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">'__ob__'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> 
    value<span class="token punctuation">.</span>__ob__ <span class="token keyword">instanceof</span> <span class="token class-name">Observer</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ob <span class="token operator">=</span> value<span class="token punctuation">.</span>__ob__
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      ob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ob <span class="token comment">//åªå¯¹objectè¿›è¡ŒåŠ«æŒ</span>
  <span class="token punctuation">}</span>
  <span class="token function">protoAugment</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> src</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> src <span class="token comment">//æ”¯æŒéšå¼åŸå‹ç›´æ¥èµ‹å€¼</span>
  <span class="token punctuation">}</span>
  <span class="token function">copyAugment</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> src<span class="token punctuation">,</span> keys</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//ä¸æ”¯æŒçš„set key</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">def</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> src<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">//å°†keyå€¼è®¾ç½®åˆ°targetæ¥æºå¯¹è±¡ä¸Šå»</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">dependArray</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// å¯¹æ•°ç»„çš„æ¯ä¸ªä¸‹æ ‡éƒ½å¤„ç†</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> e<span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> value<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      e <span class="token operator">=</span> value<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      e <span class="token operator">?</span><span class="token punctuation">.</span>__ob__ <span class="token operator">?</span><span class="token punctuation">.</span>__ob__<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dependArray</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è‡³æ­¤ï¼Œvueçš„è§‚å¯Ÿè€…å‘Šä¸€æ®µè½ã€‚
ç„¶åï¼Œè¯¥æ­¥å…¥æ­£é¢˜å»ç®€å•çš„å®ç°vueäº†ã€‚è¦ç®€å•å®ç°vueçš„ä¸€äº›ä»€ä¹ˆåŠŸèƒ½å‘¢ï¼Ÿ</p> <h2 id="example">Example</h2> <p><strong>index.html</strong></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>utf-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>IE=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>VueåŸç†æµ…æ<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>app<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>VueåŸç†è§£æ<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- è¡¨è¾¾å¼è§£æ,æ•°æ®ç»‘å®š --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>è¡¨è¾¾å¼è§£æ,æ•°æ®ç»‘å®š:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>JSON.stringify/parse:{{JSON.stringify(child)}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>eval:{{eval(&quot;text + ' word ' +  child.child.text&quot;)}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- è®¡ç®—å±æ€§ --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>è®¡ç®—å±æ€§ï¼š{{computeText}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>è®¡ç®—å±æ€§getæ–¹æ³•ï¼š{{getText}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- åŒå‘æ•°æ®ç»‘å®š --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>åŒå‘æ•°æ®ç»‘å®šã€textã€‘ï¼š<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- style --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">:</span><span class="token style-attr language-css"><span class="token attr-name"><span class="token attr-name">style</span></span><span class="token punctuation">=&quot;</span><span class="token attr-value">style</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>styleï¼š{{JSON.stringify(style)}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- äº‹ä»¶ç»‘å®š --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>numAdd(2,3,$event)<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
      äº‹ä»¶ï¼š<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">:</span><span class="token style-attr language-css"><span class="token attr-name"><span class="token attr-name">style</span></span><span class="token punctuation">='</span><span class="token attr-value"><span class="token punctuation">{</span><span class="token property">cursor</span><span class="token punctuation">:</span><span class="token string">&quot;pointer&quot;</span><span class="token punctuation">,</span><span class="token property">color</span><span class="token punctuation">:</span> blueColor<span class="token punctuation">}</span></span><span class="token punctuation">'</span></span> <span class="token attr-name"><span class="token namespace">v-on:</span>click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text = '' <span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>æ¸…ç©ºtext<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>{{num}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- class --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>pointer no-select<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>[isRed?'red': 'blue', 'bigFont']<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>isRed = !isRed<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>class: {{text}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- æŒ‡ä»¤ --&gt;</span>
    <span class="token comment">&lt;!-- v-html --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>v-htmlï¼š<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">v-html</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>strHtml<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- v-for --&gt;</span>
    v-for:ã€listã€‘ <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>addList<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>å‘listæ•°ç»„æ·»åŠ æ•°æ®<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>(item,index) in list<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>{{list}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text/css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
  <span class="token selector">.red</span><span class="token punctuation">{</span>
      <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token selector">.blue</span><span class="token punctuation">{</span>
      <span class="token property">color</span><span class="token punctuation">:</span> blue<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token selector">.pointer</span><span class="token punctuation">{</span>
      <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token selector">.bigFont</span> <span class="token punctuation">{</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span> 30px<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token selector">.active</span><span class="token punctuation">{</span>

  <span class="token punctuation">}</span>
  <span class="token selector">.no-select</span><span class="token punctuation">{</span>
    <span class="token property">user-select</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li>æ•°æ®ç»‘å®šï¼Œæ¨¡æ¿å¼•æ“è§£æ</li> <li>v-modelåŒå‘æ•°æ®ç»‘å®š</li> <li>äº‹ä»¶</li> <li>classã€style</li> <li>å¸¸ç”¨æŒ‡ä»¤ï¼šv-htmlã€v-forç­‰</li></ul> <p>æœ‰äº†æƒ³è¦å®ç°çš„ï¼Œæƒ³å¤ªå¤šå¤ªç´¯ï¼Œå…ˆå†™ä¸€ä¸ªvue<br> <strong>index.js</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'../../util/vue'</span>
window<span class="token punctuation">.</span>vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  el<span class="token punctuation">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      num<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      text<span class="token punctuation">:</span> <span class="token string">'hello'</span><span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        text<span class="token punctuation">:</span> <span class="token string">'world'</span><span class="token punctuation">,</span>
        child<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          text<span class="token punctuation">:</span> <span class="token string">'2018'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      isRed<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      list<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      strHtml<span class="token punctuation">:</span> <span class="token string">'&lt;p class=&quot;red&quot;&gt;æˆ‘æ˜¯æ¥è‡ªdataçš„html&lt;/p&gt;'</span><span class="token punctuation">,</span>
      style<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        color<span class="token punctuation">:</span> <span class="token string">'#00bbcc'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      blueColor<span class="token punctuation">:</span> <span class="token string">'blue'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  computed<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">computeText</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>text <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">.</span>text <span class="token operator">+</span> <span class="token string">' form computed'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    getText<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>text <span class="token operator">+</span> <span class="token string">' form get '</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function">numAdd</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// console.log(args)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>num <span class="token operator">++</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">addList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
      <span class="token comment">// console.log(this.list)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">beforeCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log('beforeCreated')</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log('created')</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">beforeMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log('beforeMount')</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log('mounted')</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">updated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log('updated')</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  watch<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// text: function(newVal, old) {</span>
    <span class="token comment">//   console.log(newVal,old)</span>
    <span class="token comment">// },</span>
    <span class="token comment">// 'child.text': function(newVal, old) {</span>
    <span class="token comment">//   console.log('child.text =&gt; ' + newVal)</span>
    <span class="token comment">// },</span>
    <span class="token comment">// list: function(newVal,oldVal) {</span>
    <span class="token comment">//     console.log(newVal,oldVal)</span>
    <span class="token comment">// }</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="class-vue">Class Vue</h2> <p><strong>vue/index.js</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> _ <span class="token keyword">from</span> <span class="token string">'lodash'</span>
<span class="token keyword">import</span> Observer <span class="token keyword">from</span> <span class="token string">'./observer'</span>
<span class="token keyword">import</span> Watcher <span class="token keyword">from</span> <span class="token string">'./watcher'</span>
<span class="token keyword">import</span> Compiler <span class="token keyword">from</span> <span class="token string">'./compiler'</span>
<span class="token keyword">class</span> <span class="token class-name">Vue</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$options <span class="token operator">=</span> options
    <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> options<span class="token punctuation">.</span>props
    <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> options<span class="token punctuation">.</span>data <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>watch <span class="token operator">=</span> options<span class="token punctuation">.</span>watch <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>computed <span class="token operator">=</span> options<span class="token punctuation">.</span>computed <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>methods <span class="token operator">=</span> options<span class="token punctuation">.</span>methods <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>beforeCreated <span class="token operator">=</span> options<span class="token punctuation">.</span>beforeCreated <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>created <span class="token operator">=</span> options<span class="token punctuation">.</span>created <span class="token operator">||</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>beforeMount <span class="token operator">=</span> options<span class="token punctuation">.</span>beforeMount <span class="token operator">||</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>beforeUpdate <span class="token operator">=</span> options<span class="token punctuation">.</span>beforeUpdate <span class="token operator">||</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mounted <span class="token operator">=</span> options<span class="token punctuation">.</span>mounted <span class="token operator">||</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>updated <span class="token operator">=</span> options<span class="token punctuation">.</span>updated <span class="token operator">||</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$el <span class="token operator">=</span> options<span class="token punctuation">.</span>el
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">_init</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initProxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// ä»£ç†vueå®ä¾‹ï¼Œ_renderProxy </span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initLifecycle</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// åˆå§‹åŒ–ä¸€äº›ç”Ÿå‘½å‘¨æœŸç›¸å…³çš„å±æ€§ï¼Œä»¥åŠä¸ºparent,childï¼ˆéæŠ½è±¡ç»„ä»¶ï¼‰ç­‰å±æ€§èµ‹å€¼</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initEvents</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// åˆå§‹åŒ–å­˜æ”¾äº‹ä»¶å¯¹è±¡ï¼Œçˆ¶ç»„ä»¶:hooké’©å­å¤„ç†</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initRender</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// vNodeã€$slotsã€ï¿¥scopedSlotsã€$createElementå‡½æ•°ç­‰åˆå§‹åŒ–ï¼Œ$attrsã€$listenersä»£ç†</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initInjections</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// resolve injections before data/props</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">beforeCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// ç¬¬ä¸€ä¸ªé’©å­</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initState</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initProvide</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// resolve provide after data/props</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">)</span> vm<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">expectKey</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//åˆ¤æ–­thisä¸Šçš„keyæ˜¯å¦æœ‰é‡å¤äº†</span>
    <span class="token keyword">const</span> f <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The property or method {key} already define</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">initProxy</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// vm._renderProxy = vm</span>
  <span class="token punctuation">}</span>
  <span class="token function">initLifecycle</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// vm._watcher = null</span>
    <span class="token comment">// vm._inactive = null</span>
    <span class="token comment">// vm._directInactive = false</span>
  <span class="token punctuation">}</span>
  <span class="token function">initEvents</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">initRender</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>$vnode <span class="token operator">=</span> <span class="token keyword">null</span>
    vm<span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token comment">// vm.$createElement = createElement</span>
  <span class="token punctuation">}</span>
  <span class="token function">initInjections</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">initState</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initProps</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initMethods</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>methods<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initData</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initComputed</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>computed<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initWatch</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>watch<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">initProvide</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">initProps</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">initMethods</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> methods</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>methods<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">expectKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
      Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> methods<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">initData</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//ä»£ç†data</span>
    <span class="token keyword">let</span> data <span class="token operator">=</span> vm<span class="token punctuation">.</span>data
    data <span class="token operator">=</span> vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span>
      vm<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span>
      data <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">//å°†dataä¸Šçš„keyä»£ç†åˆ°thisèº«ä¸Šï¼Œå³ this._data[key] === this[key]</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">expectKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
      Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token function-variable function">set</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newVal
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">initComputed</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> computed</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>computed<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">expectKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
      <span class="token keyword">const</span> <span class="token keyword">get</span> <span class="token operator">=</span> <span class="token keyword">typeof</span> computed<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> computed<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token punctuation">:</span> computed<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>get
      Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token keyword">get</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">initWatch</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> watch <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> watch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> handler <span class="token operator">=</span> watch<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createWatcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">createWatcher</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> handler <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      handler <span class="token operator">=</span> vm<span class="token punctuation">[</span>handler<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> handler <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">{key} of watch should be function</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> handler <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">$mount</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// if (!this.$options.render) this.$options.render = createEmptyVNode</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">beforeMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// let updateComponent = function() {</span>
    <span class="token comment">//   vm._update(vm._render(), hydrating);</span>
    <span class="token comment">// };</span>
    <span class="token comment">// new Watcher(vm, updateComponent, noop, {</span>
    <span class="token comment">//   before: function before() {</span>
    <span class="token comment">//     if (vm._isMounted &amp;&amp; !vm._isDestroyed) {</span>
    <span class="token comment">//       callHook(vm, 'beforeUpdate');</span>
    <span class="token comment">//     }</span>
    <span class="token comment">//   }</span>
    <span class="token comment">// }, true /* isRenderWatcher */ );</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$vnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">new</span> <span class="token class-name">Compiler</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span>
  <span class="token function">_update</span><span class="token punctuation">(</span><span class="token parameter">vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">// const prevVnode = vm._vnode</span>
    <span class="token comment">// vm._vnode = _.cloneDeep(vnode)</span>
    <span class="token comment">// if (!prevVnode) {</span>
    <span class="token comment">//   vm.$el = vm.__patch__(vm.$el, vnode)</span>
    <span class="token comment">// } else {</span>
    <span class="token comment">//   vm.$el = vm.__patch__(prevVnode, vnode)</span>
    <span class="token comment">// }</span>
  <span class="token punctuation">}</span>
  <span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">// const { render } = vm.$options</span>
    <span class="token comment">// let vnode</span>
    <span class="token comment">// try {</span>
    <span class="token comment">//   vnode = render.call(vm._renderProxy, vm.$createElement)</span>
    <span class="token comment">// } catch (e) {</span>
    <span class="token comment">//   vnode = vm._vnode</span>
    <span class="token comment">// }</span>
    <span class="token comment">// if (Array.isArray(vnode) &amp;&amp; vnode.length === 1) {</span>
    <span class="token comment">//   vnode = vnode[0]</span>
    <span class="token comment">// }</span>
    <span class="token comment">// if (!(vnode instanceof VNode)) {</span>
    <span class="token comment">//   vnode = createEmptyVNode()</span>
    <span class="token comment">// }</span>
    <span class="token comment">// return vnode</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Vue
</code></pre></div><p>vueä¸­çš„$mountæ˜¯newäº†ä¸€ä¸ªwatcherï¼Œé€šè¿‡æ”¹å˜_isMountedæ‰§è¡ŒupdateComponentå‡½æ•°ï¼Œå…ˆ_renderè¿”å›vNodeï¼Œ<em>updateæ¥æ”¶vNodeä½œ__patch</em>_(diffç®—æ³•)ï¼Œ__patch__å†…éƒ¨å®ç°äº†èŠ‚ç‚¹çš„æ›´æ–°æ›¿æ¢ã€‚vNodeå’Œdiffç®—æ³•æš‚ä¸åšæ·±å…¥äº†ï¼Œç›´æ¥ä»¥new Compileræ–¹å¼å»å®ç°èŠ‚ç‚¹æŒ‚è½½å’Œæ›´æ–°</p> <h2 id="class-compiler">Class Compiler</h2> <p><strong>vue/compiler.js</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>CompileUtil<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./compileHelper'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$el <span class="token operator">=</span> el <span class="token keyword">instanceof</span> <span class="token class-name">HTMLDivElement</span> <span class="token operator">?</span> el <span class="token punctuation">:</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>   <span class="token comment">// æ‹¿dom</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$vm <span class="token operator">=</span> vm  <span class="token comment">// æ‹¿vueå®ä¾‹</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$fragment <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createFragment</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">)</span>   <span class="token comment">// åˆ›å»ºç¢ç‰‡</span>
    <span class="token comment">// console.log(this.$fragment)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compileElement</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$fragment<span class="token punctuation">)</span>     <span class="token comment">//---è§£æç¢ç‰‡</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$fragment<span class="token punctuation">)</span>   <span class="token comment">//æŒ‚è½½</span>
  <span class="token punctuation">}</span>
  <span class="token function">createFragment</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> fragment <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createDocumentFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      childNode
    <span class="token keyword">while</span> <span class="token punctuation">(</span>childNode <span class="token operator">=</span> el<span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//å¾ªç¯æ‹¿åˆ°æ‰€æœ‰èŠ‚ç‚¹</span>
      <span class="token comment">// console.log(childNode)</span>
      fragment<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>childNode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> fragment
  <span class="token punctuation">}</span>
  <span class="token function">compileElement</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// èŠ‚ç‚¹ç¼–è¯‘å‡½æ•°</span>
    <span class="token comment">// console.log(el.childNodes)</span>
    Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>childNodes<span class="token punctuation">,</span> <span class="token parameter">node</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> text <span class="token operator">=</span> node<span class="token punctuation">.</span>textContent
			<span class="token keyword">const</span>	reg <span class="token operator">=</span> <span class="token regex">/\{\{((?:.|\r?\n)+?)\}\}/g</span>
      <span class="token comment">// console.log(node,text)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>childNodes <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compileElement</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>      <span class="token comment">//é€’å½’ç¼–è¯‘æ‰€æœ‰èŠ‚ç‚¹</span>
			<span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isTextNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compileText</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>       <span class="token comment">//ç¼–è¯‘æ–‡æœ¬èŠ‚ç‚¹ä¸­çš„æ¨¡æ¿</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">isElementNode</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// åˆ¤æ–­å…ƒç´ èŠ‚ç‚¹</span>
		<span class="token keyword">return</span> node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span>
	<span class="token punctuation">}</span>
  <span class="token function">isTextNode</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// åˆ¤æ–­æ–‡æœ¬èŠ‚ç‚¹</span>
		<span class="token keyword">return</span> node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">3</span>
	<span class="token punctuation">}</span>
  <span class="token function">compileText</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// æ–‡æœ¬èŠ‚ç‚¹ç¼–è¯‘</span>
    CompileUtil<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>$vm<span class="token punctuation">,</span> node<span class="token punctuation">.</span>textContent<span class="token punctuation">)</span>   <span class="token comment">// æ¸²æŸ“åˆ°èŠ‚ç‚¹</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç›®å‰çš„complieræˆ‘ä»¬æ‹¿åˆ°äº†æ–‡æœ¬èŠ‚ç‚¹åŠå…¶å†…å®¹ï¼Œæˆ‘ä»¬éœ€è¦å°†ä¸€ä¸ªå·¥å…·å‡½æ•°å°†åŒèŠ±æ‹¬å·å†…çš„è¡¨è¾¾å¼ä¸vmç»“åˆèµ·æ¥ï¼Œç„¶åç¼–è¯‘åˆ°æ–‡æœ¬èŠ‚ç‚¹ä¸­å» â†“<br> <strong>vue/compilerHelper.js</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> Watcher <span class="token keyword">from</span> <span class="token string">'./watcher'</span>
<span class="token keyword">import</span> _ <span class="token keyword">from</span> <span class="token string">'lodash'</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> CompileUtil <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token function">text</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">//ç¼–è¯‘æ–‡æœ¬</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_bind</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> <span class="token string">'text'</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token function">_bind</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> dir</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> updaterFn <span class="token operator">=</span> Updater<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">Updater</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span>     <span class="token comment">//æ ¹æ®æŒ‡ä»¤æ¥çš„æ˜¯ä»€ä¹ˆçš„æ›´æ–°ï¼Ÿ</span>
		updaterFn <span class="token operator">&amp;&amp;</span> <span class="token function">updaterFn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp<span class="token punctuation">)</span>   <span class="token comment">//å­˜åœ¨å¹¶æ›´æ–°åˆ°fragmentä¸Šå»</span>
    <span class="token comment">// new Watcher(vm, 'data', (val, oldVal) =&gt; {</span>
    <span class="token comment">//   updaterFn(node, vm, exp)</span>
    <span class="token comment">// })</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> Updater <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token function-variable function">textUpdater</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>  
    _<span class="token punctuation">.</span>templateSettings<span class="token punctuation">.</span>interpolate <span class="token operator">=</span> <span class="token regex">/{{([\s\S]+?)}}/g</span><span class="token punctuation">;</span>  <span class="token comment">// è®¾ç½®è‡ªå®šä¹‰æ¨¡ç‰ˆ</span>
    <span class="token keyword">const</span> text <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">template</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
		node<span class="token punctuation">[</span><span class="token string">'textContent'</span><span class="token punctuation">]</span> <span class="token operator">=</span> text
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸Šé¢å‡ ä¸ªç®€å•çš„å‡½æ•°å¸®åŠ©æˆ‘ä»¬å°†æ¨¡ç‰ˆä¸­çš„å†…å®¹ç¼–è¯‘æˆåŠŸï¼Œä½†æ˜¯å°šä¸”ä¸èƒ½åšåˆ°vmä¸­çš„å€¼æ”¹å˜åé‡æ–°ç¼–è¯‘ã€‚<br>
æ³¨é‡Šä¸­ç›´æ¥å¯¹dataä½œWatcherï¼Œdataæ”¹å˜å°±å»æ‰§è¡ŒupdaterFnæ˜æ˜¾ä¸å¯å–ã€‚æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦æ‹¿åˆ°è¡¨è¾¾å¼ä¸­å¯¹åº”åœ¨dataä¸­çš„keyï¼Œå¯¹è¿™äº›keyä½œWatcherï¼Œç›¸åº”çš„keyçš„å€¼å˜åŒ–ï¼Œæ‰§è¡Œç›¸å¯¹äºçš„updaterFn  â†“<br> <strong>vue/compilerHelper.js</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">_bind</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> dir</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token keyword">const</span> updaterFn <span class="token operator">=</span> Updater<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">Updater</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span>     <span class="token comment">//æ ¹æ®æŒ‡ä»¤æ¥çš„æ˜¯ä»€ä¹ˆçš„æ›´æ–°ï¼Ÿ</span>
updaterFn <span class="token operator">&amp;&amp;</span> <span class="token function">updaterFn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp<span class="token punctuation">)</span>   <span class="token comment">//å­˜åœ¨å¹¶æ›´æ–°åˆ°fragmentä¸Šå»</span>
  <span class="token comment">// new Watcher(vm, '_data', (val, oldVal) =&gt; {</span>
  <span class="token comment">//   updaterFn(node, vm, exp)</span>
  <span class="token comment">// })</span>
<span class="token keyword">const</span> temp <span class="token operator">=</span> dir <span class="token operator">===</span> <span class="token string">'text'</span><span class="token operator">?</span> <span class="token boolean">true</span><span class="token punctuation">:</span> <span class="token boolean">false</span>
<span class="token keyword">const</span> variable <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_keyOfExp</span><span class="token punctuation">(</span>exp<span class="token punctuation">,</span> temp<span class="token punctuation">)</span>    <span class="token comment">//è·å–è¡¨è¾¾å¼é‡Œçš„å˜é‡ï¼Œæ·»åŠ è®¢é˜…è€…ï¼Œå˜åŒ–åè‡ªåŠ¨æ›´æ–°</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>variable <span class="token operator">||</span> <span class="token operator">!</span>variable <span class="token keyword">in</span> vm<span class="token punctuation">)</span> <span class="token keyword">return</span>
  <span class="token comment">// console.log(variable)</span>
variable<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">updaterFn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token function">_keyOfExp</span><span class="token punctuation">(</span><span class="token parameter">exp<span class="token punctuation">,</span> temp <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//ä»ä¸€ä¸ªè¡¨è¾¾å¼(string)é‡Œæ‹¿å˜é‡(vmçš„å±æ€§)</span>
 <span class="token keyword">const</span> variaArr <span class="token operator">=</span> <span class="token punctuation">[</span>exp<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result<span class="token punctuation">,</span>item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> variaStr <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// æ¥è‡ªæ¨¡æ¿å¼•æ“ï¼Œä¹Ÿè®¸å¤šä¸ª{{}}æƒ…å†µ</span>
      item<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/\{\{((?:.|\r?\n)+?)\}\}/g</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        variaStr <span class="token operator">+=</span> <span class="token regex">/^(?:\{\{)((?:\s|\S)*)(?:\}\})$/</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      variaStr <span class="token operator">=</span> item
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token regex">/JSON\.(?:stringify|parse)\(([a-zA-Z_\$]\w*)\)/g</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>variaStr<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>RegExp<span class="token punctuation">.</span>$<span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token regex">/eval\((['&quot;])([\s\S]*)\1\)/g</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>variaStr<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      variaStr <span class="token operator">=</span> RegExp<span class="token punctuation">.</span>$<span class="token number">2</span>
    <span class="token punctuation">}</span>
    variaStr<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\s/g</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex">/[\+\-\*\/\|\&amp;]/</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">str</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> exp <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/^\w+(?:\.\w*)*$/g</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span> result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>exp<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token operator">...</span>new <span class="token class-name">Set</span><span class="token punctuation">(</span>variaArr<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¤„ç†äº†æ•°æ®å˜åŒ–è§†å›¾å“åº”ä¹‹åï¼Œæˆ‘ä»¬æ¥å¤„ç†å…¶ä»–<br> <strong>å®Œå–„ vue/compiler.js</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>CompileUtil<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./compileHelper'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$el <span class="token operator">=</span> el <span class="token keyword">instanceof</span> <span class="token class-name">HTMLDivElement</span> <span class="token operator">?</span> el <span class="token punctuation">:</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>   <span class="token comment">// æ‹¿dom</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$vm <span class="token operator">=</span> vm  <span class="token comment">// æ‹¿vueå®ä¾‹</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$fragment <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createFragment</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">)</span>   <span class="token comment">// åˆ›å»ºç¢ç‰‡</span>
    <span class="token comment">// console.log(this.$fragment)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compileElement</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$fragment<span class="token punctuation">)</span>     <span class="token comment">//---è§£æç¢ç‰‡</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$fragment<span class="token punctuation">)</span>   <span class="token comment">//æŒ‚è½½</span>
  <span class="token punctuation">}</span>
  <span class="token function">createFragment</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> fragment <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createDocumentFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      childNode
    <span class="token keyword">while</span> <span class="token punctuation">(</span>childNode <span class="token operator">=</span> el<span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//å¾ªç¯æ‹¿åˆ°æ‰€æœ‰èŠ‚ç‚¹</span>
      <span class="token comment">// console.log(childNode)</span>
      fragment<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>childNode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> fragment
  <span class="token punctuation">}</span>
  <span class="token function">compileElement</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// èŠ‚ç‚¹ç¼–è¯‘å‡½æ•°</span>
    <span class="token comment">// console.log(el.childNodes)</span>
    Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>childNodes<span class="token punctuation">,</span> <span class="token parameter">node</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> text <span class="token operator">=</span> node<span class="token punctuation">.</span>textContent
			<span class="token keyword">const</span>	reg <span class="token operator">=</span> <span class="token regex">/\{\{((?:.|\r?\n)+?)\}\}/g</span>
      <span class="token comment">// console.log(node,text)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>childNodes <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compileElement</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>      <span class="token comment">//é€’å½’ç¼–è¯‘æ‰€æœ‰èŠ‚ç‚¹</span>
			<span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isTextNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compileText</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>       <span class="token comment">//ç¼–è¯‘æ–‡æœ¬èŠ‚ç‚¹ä¸­çš„æ¨¡æ¿</span>
			<span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isElementNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment">//ç¼–è¯‘èŠ‚ç‚¹</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compileNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">compileText</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// æ–‡æœ¬èŠ‚ç‚¹ç¼–è¯‘</span>
    CompileUtil<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>$vm<span class="token punctuation">,</span> node<span class="token punctuation">.</span>textContent<span class="token punctuation">)</span>   <span class="token comment">// æ¸²æŸ“åˆ°èŠ‚ç‚¹</span>
  <span class="token punctuation">}</span>
  <span class="token function">compileNode</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>attributes<span class="token punctuation">,</span> <span class="token parameter">attr</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token comment">// console.dir(attr)</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isDirective</span><span class="token punctuation">(</span>attr<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment">//æŒ‡ä»¤çš„ç¼–è¯‘</span>
        <span class="token comment">// console.dir(attr)</span>
				<span class="token keyword">const</span> exp <span class="token operator">=</span> attr<span class="token punctuation">.</span>value<span class="token punctuation">,</span>			  <span class="token comment">//è·å–èŠ‚ç‚¹çš„å±æ€§              </span>
					<span class="token punctuation">[</span>dirFont<span class="token punctuation">,</span>dirValue<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>RegExp<span class="token punctuation">.</span>$<span class="token number">1</span><span class="token punctuation">,</span> RegExp<span class="token punctuation">.</span>$<span class="token number">2</span><span class="token punctuation">]</span>   <span class="token comment">//è·å–æŒ‡ä»¤å‰ç¼€å’Œå€¼</span>
          <span class="token comment">// console.log([dirFont,dirValue])</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token regex">/(v-on:)|@/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>dirFont<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment">//æ˜¯å¦æ˜¯äº‹ä»¶æŒ‡ä»¤</span>
					<span class="token comment">// console.log(dirFont,dirValue,exp)</span>
					CompileUtil<span class="token punctuation">.</span><span class="token function">eventHandler</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$vm<span class="token punctuation">,</span> dirValue<span class="token punctuation">,</span> exp<span class="token punctuation">)</span>   <span class="token comment">//å¤„ç†ç»‘å®šäº‹ä»¶</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// console.log(dirValue,exp)</span>
					CompileUtil<span class="token punctuation">[</span>dirValue<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> CompileUtil<span class="token punctuation">[</span>dirValue<span class="token punctuation">]</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$vm<span class="token punctuation">,</span> exp<span class="token punctuation">)</span>   <span class="token comment">//æ ¹æ®è·å–çš„æŒ‡ä»¤ï¼Œæ‰§è¡ŒæŒ‡ä»¤ç¼–è¯‘</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token function">isElementNode</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// åˆ¤æ–­å…ƒç´ èŠ‚ç‚¹</span>
		<span class="token keyword">return</span> node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span>
	<span class="token punctuation">}</span>
  <span class="token function">isTextNode</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// åˆ¤æ–­æ–‡æœ¬èŠ‚ç‚¹</span>
		<span class="token keyword">return</span> node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">3</span>
	<span class="token punctuation">}</span>
  <span class="token function">isDirective</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// åˆ¤æ–­æŒ‡ä»¤</span>
		<span class="token keyword">return</span><span class="token operator">/</span><span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token punctuation">:</span>v<span class="token operator">-</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token punctuation">:</span>\w<span class="token operator">+</span><span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">:</span><span class="token operator">|</span>@<span class="token punctuation">)</span><span class="token punctuation">(</span>\w<span class="token operator">+</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä»¥ä¸Šï¼Œæˆ‘ä»¬å®Œæˆäº†ï¼š</p> <ul><li>å¯¹èŠ‚ç‚¹å’Œæ–‡æœ¬çš„complie</li> <li>å¯¹æŒ‡ä»¤çš„åˆ¤æ–­</li> <li>å¯¹äº‹ä»¶çš„å¤„ç†</li></ul> <p><strong>å®Œå–„ vue/compilerHelper.js</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> Watcher <span class="token keyword">from</span> <span class="token string">'./watcher'</span>
<span class="token keyword">import</span> _ <span class="token keyword">from</span> <span class="token string">'lodash'</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> CompileUtil <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">text</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//ç¼–è¯‘æ–‡æœ¬</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_bind</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> <span class="token string">'text'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">eventHandler</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> eventType<span class="token punctuation">,</span> exp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// with(vm) {</span>
      <span class="token comment">// 	eval(exp)        //æ‰§è¡Œäº‹ä»¶é‡Œçš„å‡½æ•°</span>
      <span class="token comment">// }</span>
      <span class="token function">_with</span><span class="token punctuation">(</span>exp<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token regex">/^\$event$/</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> o <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token keyword">in</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            o<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>e<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">expOrFn<span class="token punctuation">,</span> $<span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/^this\.(\w+)$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>expOrFn<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> $<span class="token number">1</span> <span class="token keyword">in</span> vm<span class="token punctuation">.</span>methods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          expOrFn <span class="token operator">+=</span> <span class="token string">'()'</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> expOrFn
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">model</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>nodeName <span class="token operator">==</span> <span class="token string">'INPUT'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_bind</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> <span class="token string">'model'</span><span class="token punctuation">)</span>
      node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> val <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value
        vm<span class="token punctuation">[</span>exp<span class="token punctuation">]</span> <span class="token operator">=</span> val
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">class</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_bind</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> <span class="token string">'class'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">style</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_bind</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> <span class="token string">'style'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">_bind</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> dir</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> updaterFn <span class="token operator">=</span> Updater<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">Updater</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token comment">//æ ¹æ®æŒ‡ä»¤æ¥çš„æ˜¯ä»€ä¹ˆçš„æ›´æ–°ï¼Ÿ</span>
    updaterFn <span class="token operator">&amp;&amp;</span> <span class="token function">updaterFn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp<span class="token punctuation">)</span> <span class="token comment">//å­˜åœ¨å¹¶æ›´æ–°åˆ°fragmentä¸Šå»</span>
    <span class="token comment">// new Watcher(vm, '_data', (val, oldVal) =&gt; {</span>
    <span class="token comment">//   updaterFn(node, vm, exp)</span>
    <span class="token comment">// })</span>
    <span class="token keyword">const</span> variable <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_keyOfExp</span><span class="token punctuation">(</span>exp<span class="token punctuation">,</span> dir<span class="token punctuation">)</span> <span class="token comment">//è·å–è¡¨è¾¾å¼é‡Œçš„å˜é‡ï¼Œæ·»åŠ è®¢é˜…è€…ï¼Œå˜åŒ–åè‡ªåŠ¨æ›´æ–°</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>variable <span class="token operator">||</span> <span class="token operator">!</span>variable <span class="token keyword">in</span> vm<span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token comment">// console.log(variable)</span>
    variable<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">updaterFn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">_keyOfExp</span><span class="token punctuation">(</span>exp<span class="token punctuation">,</span> temp <span class="token operator">=</span> <span class="token string">'text'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//ä»ä¸€ä¸ªè¡¨è¾¾å¼(string)é‡Œæ‹¿å˜é‡(vmçš„å±æ€§) </span>
    <span class="token keyword">const</span> variaArr <span class="token operator">=</span> <span class="token punctuation">[</span>exp<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result<span class="token punctuation">,</span> item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> variaStr <span class="token operator">=</span> <span class="token string">''</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>temp <span class="token operator">===</span> <span class="token string">'text'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// æ¥è‡ªæ¨¡æ¿å¼•æ“ï¼Œä¹Ÿè®¸å¤šä¸ª{{}}æƒ…å†µ</span>
        item<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/\{\{((?:.|\r?\n)+?)\}\}/g</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> mv <span class="token operator">=</span> <span class="token regex">/^(?:\{\{)((?:\s|\S)*)(?:\}\})$/</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'+'</span>
          variaStr <span class="token operator">+=</span> mv
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>temp <span class="token operator">===</span> <span class="token string">'class'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        variaStr <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/^\[([\s\S]+?)\]$/</span><span class="token punctuation">,</span> <span class="token string">'$1'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        variaStr <span class="token operator">=</span> item
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/JSON\.(?:stringify|parse)\(([a-zA-Z_\$]\w*)\)/g</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>variaStr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>RegExp<span class="token punctuation">.</span>$<span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/eval\((['&quot;])([\s\S]*)\1\)/g</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>variaStr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        variaStr <span class="token operator">=</span> RegExp<span class="token punctuation">.</span>$<span class="token number">2</span>
      <span class="token punctuation">}</span>
      variaStr<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/[\s\r\n]/g</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex">/[\+\-\*\/\|\&amp;,\?]/</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">str</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> nExp <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/^\w+(?:\.\w*)*$/g</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nExp<span class="token punctuation">)</span> result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>nExp<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> result
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token operator">...</span>new <span class="token class-name">Set</span><span class="token punctuation">(</span>variaArr<span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> classI <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
  proClass

<span class="token keyword">export</span> <span class="token keyword">const</span> Updater <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">textUpdater</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _<span class="token punctuation">.</span>templateSettings<span class="token punctuation">.</span>interpolate <span class="token operator">=</span> <span class="token regex">/{{([\s\S]+?)}}/g</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> text <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">template</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
    node<span class="token punctuation">[</span><span class="token string">'textContent'</span><span class="token punctuation">]</span> <span class="token operator">=</span> text
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">modelUpdater</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> vm<span class="token punctuation">[</span>exp<span class="token punctuation">]</span>
    node<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">typeof</span> value <span class="token operator">==</span> <span class="token string">'undefined'</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token punctuation">:</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">classUpdater</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _<span class="token punctuation">.</span>templateSettings<span class="token punctuation">.</span>interpolate <span class="token operator">=</span> <span class="token regex">/{{([\s\S]+?)}}/g</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> nExp <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">{{</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>exp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}}</span><span class="token template-punctuation string">`</span></span>
    <span class="token keyword">const</span> classNames <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">template</span><span class="token punctuation">(</span>nExp<span class="token punctuation">)</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span> 
    <span class="token operator">!</span>classI <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>proClass <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>node<span class="token punctuation">.</span>classList<span class="token punctuation">]</span><span class="token punctuation">)</span>
    node<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>proClass<span class="token punctuation">,</span> <span class="token operator">...</span>classNames<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
    classI<span class="token operator">++</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">styleUpdater</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> exp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">_with</span><span class="token punctuation">(</span>exp<span class="token punctuation">,</span>vm<span class="token punctuation">)</span>
    node<span class="token punctuation">.</span>style <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">sty<span class="token punctuation">,</span>key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> style <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span>
      sty <span class="token operator">+=</span> style
      <span class="token keyword">return</span> sty
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">_with</span><span class="token punctuation">(</span><span class="token parameter">exp<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> extraRule<span class="token punctuation">,</span> extraFn<span class="token punctuation">,</span> otherFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> expOrFn<span class="token punctuation">,</span> rule <span class="token operator">=</span> <span class="token regex">/([a-zA-Z\$]+\w*)/g</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex">/^{[\s\S]+?}$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rule <span class="token operator">=</span> <span class="token regex">/\:\s*([a-zA-Z\$]+\w*)/g</span>
    exp <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\s/g</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  expOrFn <span class="token operator">=</span>  exp<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> nb<span class="token punctuation">,</span> i <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
    <span class="token keyword">const</span> f <span class="token operator">=</span> extraRule <span class="token keyword">instanceof</span> <span class="token class-name">RegExp</span> <span class="token operator">&amp;&amp;</span> extraRule<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>f<span class="token punctuation">)</span> nb <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">this.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>b<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      nb <span class="token operator">=</span> <span class="token keyword">typeof</span> extraFn <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">extraFn</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    a <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
    a<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>nb<span class="token punctuation">)</span>
    <span class="token keyword">return</span> a<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> otherFn <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> expOrFn <span class="token operator">=</span> <span class="token function">otherFn</span><span class="token punctuation">(</span>expOrFn<span class="token punctuation">,</span> RegExp<span class="token punctuation">.</span>$<span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">'return '</span> <span class="token operator">+</span> expOrFn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œå®ç°äº†â†“</p> <ul><li>æ¨¡æ¿è§£æ</li> <li>äº‹ä»¶ç»‘å®š</li> <li>v-model</li> <li>:style</li> <li>:class</li></ul> <hr> <p><strong><a href="https://github.com/Mackkkk/webEffect/tree/master/src/view/vuerealization" target="_blank" rel="noopener noreferrer">~gayhub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></strong></p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/SummaryOfwork/blog/" class="prev router-link-active">
          é¢è¯•æ—¥å¸¸
        </a></span> <span class="next"><a href="/SummaryOfwork/blog/js/reduce.html">
          reduceå®ç°
        </a>
        â†’
      </span></p></div> </div> <!----></div></div>
    <script src="/SummaryOfwork/assets/js/app.775f6a5d.js" defer></script><script src="/SummaryOfwork/assets/js/33.be1909ae.js" defer></script>
  </body>
</html>
